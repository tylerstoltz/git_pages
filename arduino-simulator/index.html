<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Simulator - Developer Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            color: #569cd6;
            text-decoration: none;
            font-size: 1.2rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #6ab0de;
        }

        h1 {
            color: #d4d4d4;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .container {
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .panel {
            background: #252526;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
        }

        .panel-header {
            background: #2d2d30;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 500;
            font-size: 0.95rem;
            color: #d4d4d4;
        }

        .panel-content {
            padding: 1rem;
        }

        /* Editor Styles */
        #codeEditor {
            width: 100%;
            min-height: 400px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            tab-size: 2;
        }

        #codeEditor:focus {
            outline: 1px solid #569cd6;
        }

        .example-selector {
            margin-bottom: 1rem;
        }

        .example-selector label {
            display: block;
            margin-bottom: 0.5rem;
            color: #858585;
            font-size: 0.9rem;
        }

        .example-selector select {
            width: 100%;
            padding: 0.5rem;
            background: #2d2d30;
            color: #d4d4d4;
            border: 1px solid #404040;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .example-selector select:focus {
            outline: 1px solid #569cd6;
        }

        /* Control Panel */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1.25rem;
            background: #0e639c;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn:disabled {
            background: #404040;
            color: #858585;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #d16969;
        }

        .btn-stop:hover:not(:disabled) {
            background: #e07979;
        }

        .btn-reset {
            background: #858585;
        }

        .btn-reset:hover:not(:disabled) {
            background: #959595;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .speed-control label {
            color: #858585;
            font-size: 0.9rem;
        }

        .speed-control input[type="range"] {
            width: 120px;
        }

        .speed-value {
            color: #4ec9b0;
            font-weight: 500;
            min-width: 40px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #2d2d30;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #858585;
        }

        .status-indicator.running {
            background: #4ec9b0;
            box-shadow: 0 0 8px #4ec9b0;
        }

        .status-indicator.error {
            background: #f48771;
            box-shadow: 0 0 8px #f48771;
        }

        /* Arduino Board */
        .board-container {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .arduino-board {
            background: #2b7a9c;
            padding: 2rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .board-label {
            text-align: center;
            color: #fff;
            font-weight: 500;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .builtin-led-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .builtin-led-label {
            color: #fff;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .builtin-led {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3a3a3a;
            margin: 0 auto;
            transition: all 0.2s;
            border: 2px solid #1a1a1a;
        }

        .builtin-led.on {
            background: #ff0000;
            box-shadow: 0 0 20px #ff0000, 0 0 40px rgba(255, 0, 0, 0.5);
        }

        .digital-pins {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .pin-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .pin-label {
            color: #fff;
            font-size: 0.7rem;
        }

        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3a3a3a;
            transition: all 0.2s;
            border: 1px solid #1a1a1a;
        }

        .led.on {
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }

        .analog-inputs {
            background: #1e4d5e;
            padding: 1rem;
            border-radius: 4px;
        }

        .analog-title {
            color: #fff;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .analog-input {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .analog-input label {
            color: #fff;
            font-size: 0.8rem;
            min-width: 25px;
        }

        .analog-input input[type="range"] {
            flex: 1;
        }

        .analog-value {
            color: #4ec9b0;
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 40px;
            text-align: right;
        }

        .pin-states {
            width: 100%;
            max-width: 400px;
        }

        .pin-states-title {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: #858585;
        }

        .pin-states-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .pin-state {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: #2d2d30;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .pin-state-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3a3a3a;
        }

        .pin-state-indicator.high {
            background: #4ec9b0;
        }

        .pin-state-name {
            color: #858585;
            min-width: 30px;
        }

        .pin-state-value {
            color: #d4d4d4;
            margin-left: auto;
        }

        /* Board Panel Tabs */
        .board-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #1e1e1e;
            border-bottom: 1px solid #404040;
        }

        .board-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            color: #858585;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .board-tab:hover {
            background: #2d2d30;
            color: #d4d4d4;
        }

        .board-tab.active {
            background: #252526;
            color: #d4d4d4;
            border-bottom: 2px solid #569cd6;
        }

        .board-tab-content {
            display: none;
        }

        .board-tab-content.active {
            display: block;
        }

        /* Serial Monitor */
        .serial-monitor {
            grid-column: 1 / -1;
        }

        #serialOutput {
            width: 100%;
            height: 200px;
            background: #1e1e1e;
            color: #4ec9b0;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-y: auto;
            resize: vertical;
        }

        .btn-clear {
            background: #858585;
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
        }

        .btn-clear:hover:not(:disabled) {
            background: #959595;
        }

        /* Synthesizer Control Panel */
        .synth-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            color: #858585;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .synth-select {
            padding: 0.5rem;
            background: #2d2d30;
            color: #d4d4d4;
            border: 1px solid #404040;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .synth-select:focus {
            outline: 1px solid #569cd6;
        }

        .synth-slider {
            width: 100%;
            height: 6px;
            background: #404040;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .synth-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #569cd6;
            border-radius: 50%;
            cursor: pointer;
        }

        .synth-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #569cd6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .note-control {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem;
            background: #2d2d30;
            border-radius: 4px;
            border: 1px solid #404040;
        }

        .note-control label {
            color: #d4d4d4;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .note-slider {
            width: 100%;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .note-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #4ec9b0;
            border-radius: 50%;
            cursor: pointer;
        }

        .note-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #4ec9b0;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        #volumeDisplay,
        #noteDurationDisplay {
            color: #4ec9b0;
            font-weight: 600;
        }

        [id^="note"][id$="Display"] {
            color: #4ec9b0;
            font-weight: 600;
        }

        /* Advanced Synth Controls */
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 0.5rem;
            padding: 1rem;
            background: #1e1e1e;
            border-radius: 4px;
            border: 1px solid #404040;
        }

        .control-subsection {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-sublabel {
            color: #858585;
            font-size: 0.85rem;
            font-weight: 500;
        }

        #filterFreqDisplay,
        #filterQDisplay,
        #detuneDisplay,
        #attackDisplay,
        #releaseDisplay,
        #advVolumeDisplay {
            color: #4ec9b0;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .notes-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            .digital-pins {
                grid-template-columns: repeat(4, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .speed-control {
                margin-left: 0;
                justify-content: space-between;
            }

            .pin-states-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .digital-pins {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="../index.html" class="back-link">‚Üê</a>
        <h1>Arduino Simulator</h1>
    </div>

    <div class="container">
        <div class="main-grid">
            <!-- Code Editor Panel -->
            <div class="panel editor-panel">
                <div class="panel-header">
                    <span class="panel-title">Code Editor</span>
                </div>
                <div class="panel-content">
                    <div class="example-selector">
                        <label for="exampleSelect">Load Example:</label>
                        <select id="exampleSelect">
                            <option value="">-- Select an example --</option>
                            <option value="blink">Blink (LED on/off)</option>
                            <option value="serial">Serial Hello World</option>
                            <option value="analog">Analog Read</option>
                            <option value="multiple">Multiple LEDs (Knight Rider)</option>
                            <option value="fade">PWM Fade</option>
                            <option value="button">Digital Read (Simulated)</option>
                            <option value="synthesizer">Tone Synthesizer (Musical Scale)</option>
                            <option value="advSynth">üéõ Advanced Synthesizer (Filters & Envelopes)</option>
                        </select>
                    </div>
                    <textarea id="codeEditor" spellcheck="false" placeholder="// Write your Arduino code here..."></textarea>
                    <div class="controls">
                        <button id="uploadBtn" class="btn">
                            <span>üì§</span>
                            <span>Upload</span>
                        </button>
                        <button id="stopBtn" class="btn btn-stop" disabled>
                            <span>‚èπ</span>
                            <span>Stop</span>
                        </button>
                        <button id="resetBtn" class="btn btn-reset">
                            <span>üîÑ</span>
                            <span>Reset</span>
                        </button>
                        <div class="status">
                            <div id="statusIndicator" class="status-indicator"></div>
                            <span id="statusText">Ready</span>
                        </div>
                        <div class="speed-control">
                            <label for="speedSlider">Speed:</label>
                            <input type="range" id="speedSlider" min="0" max="4" value="2" step="1">
                            <span class="speed-value" id="speedValue">1x</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arduino Board Panel -->
            <div class="panel board-panel">
                <div class="panel-header">
                    <span class="panel-title">Arduino UNO</span>
                </div>
                <div class="board-tabs">
                    <button class="board-tab active" data-tab="board">Board</button>
                    <button class="board-tab" data-tab="controls" id="controlsTab">Controls</button>
                </div>
                <div class="board-tab-content active" id="boardTabContent">
                    <div class="board-container">
                    <div class="arduino-board">
                        <div class="board-label">ARDUINO UNO</div>

                        <div class="builtin-led-section">
                            <div class="builtin-led-label">Built-in LED (Pin 13)</div>
                            <div id="builtinLed" class="builtin-led"></div>
                        </div>

                        <div class="digital-pins">
                            <div class="pin-container">
                                <span class="pin-label">D0</span>
                                <div class="led" data-pin="0"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D1</span>
                                <div class="led" data-pin="1"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D2</span>
                                <div class="led" data-pin="2"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D3</span>
                                <div class="led" data-pin="3"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D4</span>
                                <div class="led" data-pin="4"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D5</span>
                                <div class="led" data-pin="5"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D6</span>
                                <div class="led" data-pin="6"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D7</span>
                                <div class="led" data-pin="7"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D8</span>
                                <div class="led" data-pin="8"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D9</span>
                                <div class="led" data-pin="9"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D10</span>
                                <div class="led" data-pin="10"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D11</span>
                                <div class="led" data-pin="11"></div>
                            </div>
                            <div class="pin-container">
                                <span class="pin-label">D12</span>
                                <div class="led" data-pin="12"></div>
                            </div>
                        </div>

                        <div class="analog-inputs">
                            <div class="analog-title">Analog Inputs</div>
                            <div class="analog-input">
                                <label>A0:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="0">
                                <span class="analog-value" data-value="0">0</span>
                            </div>
                            <div class="analog-input">
                                <label>A1:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="1">
                                <span class="analog-value" data-value="1">0</span>
                            </div>
                            <div class="analog-input">
                                <label>A2:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="2">
                                <span class="analog-value" data-value="2">0</span>
                            </div>
                            <div class="analog-input">
                                <label>A3:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="3">
                                <span class="analog-value" data-value="3">0</span>
                            </div>
                            <div class="analog-input">
                                <label>A4:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="4">
                                <span class="analog-value" data-value="4">0</span>
                            </div>
                            <div class="analog-input">
                                <label>A5:</label>
                                <input type="range" min="0" max="1023" value="0" data-analog="5">
                                <span class="analog-value" data-value="5">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="pin-states">
                        <div class="pin-states-title">Pin States</div>
                        <div class="pin-states-grid" id="pinStatesGrid">
                            <!-- Generated dynamically -->
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Controls Tab Content -->
                <div class="board-tab-content" id="controlsTabContent">
                    <div class="panel-content">
                        <!-- Basic Synthesizer Controls -->
                        <div class="synth-controls" id="basicSynthControls" style="display: none;">
                        <div class="control-section">
                            <label class="control-label">Waveform Type:</label>
                            <select id="waveformSelect" class="synth-select">
                                <option value="square">Square (Arduino Default)</option>
                                <option value="sine">Sine</option>
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth">Sawtooth</option>
                            </select>
                        </div>

                        <div class="control-section">
                            <label class="control-label">Volume: <span id="volumeDisplay">10%</span></label>
                            <input type="range" id="volumeSlider" min="0" max="100" value="10" class="synth-slider">
                        </div>

                        <div class="control-section">
                            <label class="control-label">Note Duration: <span id="noteDurationDisplay">400ms</span></label>
                            <input type="range" id="noteDurationSlider" min="100" max="2000" value="400" step="50" class="synth-slider">
                        </div>

                        <div class="control-section">
                            <label class="control-label">Note Frequencies (Hz):</label>
                            <div class="notes-grid">
                                <div class="note-control">
                                    <label>C4: <span id="note0Display">262</span> Hz</label>
                                    <input type="range" id="note0Slider" min="100" max="800" value="262" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>D4: <span id="note1Display">294</span> Hz</label>
                                    <input type="range" id="note1Slider" min="100" max="800" value="294" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>E4: <span id="note2Display">330</span> Hz</label>
                                    <input type="range" id="note2Slider" min="100" max="800" value="330" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>F4: <span id="note3Display">349</span> Hz</label>
                                    <input type="range" id="note3Slider" min="100" max="800" value="349" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>G4: <span id="note4Display">392</span> Hz</label>
                                    <input type="range" id="note4Slider" min="100" max="800" value="392" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>A4: <span id="note5Display">440</span> Hz</label>
                                    <input type="range" id="note5Slider" min="100" max="800" value="440" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>B4: <span id="note6Display">494</span> Hz</label>
                                    <input type="range" id="note6Slider" min="100" max="800" value="494" class="note-slider">
                                </div>
                                <div class="note-control">
                                    <label>C5: <span id="note7Display">523</span> Hz</label>
                                    <input type="range" id="note7Slider" min="100" max="800" value="523" class="note-slider">
                                </div>
                            </div>
                        </div>

                        <div class="control-section">
                            <button id="resetNotesBtn" class="btn">Reset to Default Notes</button>
                        </div>
                        </div>

                        <!-- Advanced Synthesizer Controls -->
                        <div class="synth-controls" id="advSynthControls" style="display: none;">
                        <div class="control-section">
                            <label class="control-label">Waveform Type:</label>
                            <select id="advWaveformSelect" class="synth-select">
                                <option value="square">Square</option>
                                <option value="sine">Sine</option>
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth">Sawtooth</option>
                            </select>
                        </div>

                        <div class="control-section">
                            <label class="control-label">Volume: <span id="advVolumeDisplay">10%</span></label>
                            <input type="range" id="advVolumeSlider" min="0" max="100" value="10" class="synth-slider">
                        </div>

                        <div class="control-section">
                            <label class="control-label">üéö Filter Controls</label>
                            <div class="filter-controls">
                                <div class="control-subsection">
                                    <label class="control-sublabel">Filter Type:</label>
                                    <select id="filterTypeSelect" class="synth-select">
                                        <option value="lowpass">Lowpass</option>
                                        <option value="highpass">Highpass</option>
                                        <option value="bandpass">Bandpass</option>
                                        <option value="notch">Notch</option>
                                    </select>
                                </div>

                                <div class="control-subsection">
                                    <label class="control-sublabel">Cutoff Frequency: <span id="filterFreqDisplay">1000</span> Hz</label>
                                    <input type="range" id="filterFreqSlider" min="50" max="5000" value="1000" class="synth-slider">
                                </div>

                                <div class="control-subsection">
                                    <label class="control-sublabel">Resonance (Q): <span id="filterQDisplay">1.0</span></label>
                                    <input type="range" id="filterQSlider" min="0.1" max="20" value="1" step="0.1" class="synth-slider">
                                </div>
                            </div>
                        </div>

                        <div class="control-section">
                            <label class="control-label">üéµ Modulation</label>
                            <div class="control-subsection">
                                <label class="control-sublabel">Detune: <span id="detuneDisplay">0</span> cents</label>
                                <input type="range" id="detuneSlider" min="-100" max="100" value="0" class="synth-slider">
                            </div>
                        </div>

                        <div class="control-section">
                            <label class="control-label">üìà Envelope (ADSR)</label>
                            <div class="control-subsection">
                                <label class="control-sublabel">Attack: <span id="attackDisplay">0.01</span> s</label>
                                <input type="range" id="attackSlider" min="0" max="1" value="0.01" step="0.01" class="synth-slider">
                            </div>
                            <div class="control-subsection">
                                <label class="control-sublabel">Release: <span id="releaseDisplay">0.1</span> s</label>
                                <input type="range" id="releaseSlider" min="0" max="2" value="0.1" step="0.01" class="synth-slider">
                            </div>
                        </div>

                        <div class="control-section">
                            <button id="resetAdvSynthBtn" class="btn">Reset to Defaults</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Serial Monitor Panel -->
            <div class="panel serial-monitor">
                <div class="panel-header">
                    <span class="panel-title">Serial Monitor</span>
                    <button id="clearSerialBtn" class="btn btn-clear">üóë Clear</button>
                </div>
                <div class="panel-content">
                    <div id="serialOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Arduino Simulator Implementation
        class ArduinoSimulator {
            constructor() {
                this.pins = Array(14).fill(0); // Digital pins D0-D13
                this.pinModes = Array(14).fill(0); // 0=INPUT, 1=OUTPUT
                this.analogPins = Array(6).fill(0); // Analog pins A0-A5
                this.pwmPins = Array(14).fill(0); // PWM values 0-255
                this.serialBuffer = [];
                this.startTime = Date.now();
                this.isRunning = false;
                this.loopInterval = null;
                this.speedMultiplier = 1.0;

                // Audio support for tone() function
                this.audioContext = null;
                this.oscillators = {}; // Track oscillators by pin
                this.gainNodes = {}; // Track gain nodes by pin
                this.filters = {}; // Track filter nodes by pin

                // Synthesizer settings
                this.synthSettings = {
                    waveform: 'square',
                    volume: 0.1,
                    noteDuration: 400,
                    noteFrequencies: [262, 294, 330, 349, 392, 440, 494, 523]
                };

                // Advanced synthesizer settings
                this.advSynthSettings = {
                    filterEnabled: false,
                    filterType: 'lowpass',
                    filterFrequency: 1000,
                    filterResonance: 1,
                    detune: 0,
                    attack: 0.01,
                    release: 0.1
                };

                // Constants
                this.HIGH = 1;
                this.LOW = 0;
                this.INPUT = 0;
                this.OUTPUT = 1;
                this.LED_BUILTIN = 13;
                this.A0 = 14;
                this.A1 = 15;
                this.A2 = 16;
                this.A3 = 17;
                this.A4 = 18;
                this.A5 = 19;

                // Create Serial object with proper 'this' binding
                const self = this;
                this.Serial = {
                    begin: (baud) => {
                        self.addToSerial(`Serial initialized at ${baud} baud`);
                    },
                    print: (text) => {
                        self.addToSerial(text, false);
                    },
                    println: (text) => {
                        self.addToSerial(text, true);
                    }
                };
            }

            pinMode(pin, mode) {
                if (pin >= 0 && pin < 14) {
                    this.pinModes[pin] = mode;
                }
            }

            digitalWrite(pin, value) {
                if (pin >= 0 && pin < 14 && this.pinModes[pin] === this.OUTPUT) {
                    this.pins[pin] = value ? 1 : 0;
                    this.pwmPins[pin] = value ? 255 : 0;
                    updateUI();
                }
            }

            digitalRead(pin) {
                if (pin >= 0 && pin < 14) {
                    return this.pins[pin];
                }
                return 0;
            }

            analogRead(pin) {
                // Convert A0-A5 constants to array index
                let index = pin;
                if (pin >= 14 && pin <= 19) {
                    index = pin - 14;
                }
                if (index >= 0 && index < 6) {
                    return this.analogPins[index];
                }
                return 0;
            }

            analogWrite(pin, value) {
                if (pin >= 0 && pin < 14) {
                    // PWM pins: 3, 5, 6, 9, 10, 11
                    const pwmCapable = [3, 5, 6, 9, 10, 11];
                    if (pwmCapable.includes(pin)) {
                        value = Math.max(0, Math.min(255, value));
                        this.pwmPins[pin] = value;
                        this.pins[pin] = value > 127 ? 1 : 0;
                        updateUI();
                    }
                }
            }

            tone(pin, frequency, duration) {
                if (pin < 0 || pin >= 14) return;

                // Initialize audio context on first use (requires user gesture)
                if (!this.audioContext) {
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error('Web Audio API not supported:', e);
                        return;
                    }
                }

                // Stop any existing tone on this pin
                this.noTone(pin);

                const now = this.audioContext.currentTime;

                // Create oscillator and gain node
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.type = this.synthSettings.waveform;
                oscillator.frequency.setValueAtTime(frequency, now);

                // Apply detune if advanced synth is active
                if (this.advSynthSettings.detune !== 0) {
                    oscillator.detune.setValueAtTime(this.advSynthSettings.detune, now);
                }

                // Apply attack envelope
                const attackTime = this.advSynthSettings.attack;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(this.synthSettings.volume, now + attackTime);

                // Create and configure filter if enabled
                let filterNode = null;
                if (this.advSynthSettings.filterEnabled) {
                    filterNode = this.audioContext.createBiquadFilter();
                    filterNode.type = this.advSynthSettings.filterType;
                    filterNode.frequency.setValueAtTime(this.advSynthSettings.filterFrequency, now);
                    filterNode.Q.setValueAtTime(this.advSynthSettings.filterResonance, now);
                }

                // Connect audio nodes
                oscillator.connect(gainNode);
                if (filterNode) {
                    gainNode.connect(filterNode);
                    filterNode.connect(this.audioContext.destination);
                    this.filters[pin] = filterNode;
                } else {
                    gainNode.connect(this.audioContext.destination);
                }

                oscillator.start(now);

                // Store references
                this.oscillators[pin] = oscillator;
                this.gainNodes[pin] = gainNode;

                // If duration is specified, automatically stop after duration
                if (duration) {
                    setTimeout(() => {
                        this.noTone(pin);
                    }, duration / this.speedMultiplier);
                }

                // Set pin HIGH to indicate sound is playing
                this.pins[pin] = 1;
                updateUI();
            }

            noTone(pin) {
                if (pin < 0 || pin >= 14) return;

                const releaseTime = this.advSynthSettings.release;

                // Apply release envelope if oscillator exists
                if (this.gainNodes[pin] && this.audioContext) {
                    const now = this.audioContext.currentTime;
                    const gainNode = this.gainNodes[pin];

                    try {
                        // Ramp down to 0 over release time
                        gainNode.gain.cancelScheduledValues(now);
                        gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                        gainNode.gain.linearRampToValueAtTime(0, now + releaseTime);
                    } catch (e) {
                        // Ignore errors
                    }
                }

                // Stop and clean up oscillator after release time
                setTimeout(() => {
                    if (this.oscillators[pin]) {
                        try {
                            this.oscillators[pin].stop();
                            this.oscillators[pin].disconnect();
                        } catch (e) {
                            // Oscillator might already be stopped
                        }
                        delete this.oscillators[pin];
                    }

                    // Clean up gain node
                    if (this.gainNodes[pin]) {
                        try {
                            this.gainNodes[pin].disconnect();
                        } catch (e) {
                            // Gain node might already be disconnected
                        }
                        delete this.gainNodes[pin];
                    }

                    // Clean up filter node
                    if (this.filters[pin]) {
                        try {
                            this.filters[pin].disconnect();
                        } catch (e) {
                            // Filter might already be disconnected
                        }
                        delete this.filters[pin];
                    }

                    // Set pin LOW
                    this.pins[pin] = 0;
                    updateUI();
                }, releaseTime * 1000);
            }

            delay(ms) {
                return new Promise(resolve =>
                    setTimeout(resolve, ms / this.speedMultiplier)
                );
            }

            millis() {
                return Math.floor((Date.now() - this.startTime) * this.speedMultiplier);
            }

            // Synthesizer helper methods
            getNoteFrequency(index) {
                if (index >= 0 && index < this.synthSettings.noteFrequencies.length) {
                    return this.synthSettings.noteFrequencies[index];
                }
                return 440; // Default to A4
            }

            getNoteDuration() {
                return this.synthSettings.noteDuration;
            }

            // Advanced synthesizer helper methods
            setFilterEnabled(enabled) {
                this.advSynthSettings.filterEnabled = enabled;
            }

            setFilterType(type) {
                this.advSynthSettings.filterType = type;
            }

            setFilterFrequency(freq) {
                this.advSynthSettings.filterFrequency = freq;
            }

            setFilterResonance(q) {
                this.advSynthSettings.filterResonance = q;
            }

            setDetune(cents) {
                this.advSynthSettings.detune = cents;
            }

            setAttack(seconds) {
                this.advSynthSettings.attack = seconds;
            }

            setRelease(seconds) {
                this.advSynthSettings.release = seconds;
            }

            addToSerial(text, newline = true) {
                const output = document.getElementById('serialOutput');
                if (newline) {
                    output.textContent += text + '\n';
                } else {
                    output.textContent += text;
                }
                output.scrollTop = output.scrollHeight;

                // Limit to last 1000 lines
                const lines = output.textContent.split('\n');
                if (lines.length > 1000) {
                    output.textContent = lines.slice(-1000).join('\n');
                }
            }

            reset() {
                // Stop all tones
                for (let pin in this.oscillators) {
                    this.noTone(parseInt(pin));
                }

                // Clean up any remaining filters
                for (let pin in this.filters) {
                    try {
                        this.filters[pin].disconnect();
                    } catch (e) {}
                    delete this.filters[pin];
                }

                this.pins.fill(0);
                this.pinModes.fill(0);
                this.analogPins.fill(0);
                this.pwmPins.fill(0);
                this.serialBuffer = [];
                this.startTime = Date.now();
                this.isRunning = false;
                if (this.loopInterval) {
                    clearInterval(this.loopInterval);
                    this.loopInterval = null;
                }
                document.getElementById('serialOutput').textContent = '';
                updateUI();
            }

            setSpeedMultiplier(speed) {
                this.speedMultiplier = speed;
            }
        }

        // Global Arduino instance
        const arduino = new ArduinoSimulator();

        // Code Examples
        const examples = {
            blink: `void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  delay(1000);
}`,
            serial: `void setup() {
  Serial.begin(9600);
}

void loop() {
  Serial.println("Hello, Arduino!");
  delay(2000);
}`,
            analog: `void setup() {
  Serial.begin(9600);
}

void loop() {
  int sensorValue = analogRead(A0);
  Serial.print("Sensor A0: ");
  Serial.println(sensorValue);
  delay(500);
}`,
            multiple: `void setup() {
  for (int i = 2; i <= 7; i++) {
    pinMode(i, OUTPUT);
  }
}

void loop() {
  for (int i = 2; i <= 7; i++) {
    digitalWrite(i, HIGH);
    delay(100);
    digitalWrite(i, LOW);
  }
  for (int i = 7; i >= 2; i--) {
    digitalWrite(i, HIGH);
    delay(100);
    digitalWrite(i, LOW);
  }
}`,
            fade: `int brightness = 0;
int fadeAmount = 5;

void setup() {
  pinMode(9, OUTPUT);
}

void loop() {
  analogWrite(9, brightness);
  brightness = brightness + fadeAmount;
  if (brightness <= 0 || brightness >= 255) {
    fadeAmount = -fadeAmount;
  }
  delay(30);
}`,
            button: `void setup() {
  pinMode(2, INPUT);
  pinMode(13, OUTPUT);
  Serial.begin(9600);
}

void loop() {
  int buttonState = digitalRead(2);
  digitalWrite(13, buttonState);
  Serial.print("Button: ");
  Serial.println(buttonState);
  delay(100);
}`,
            synthesizer: `// Arduino Synthesizer with Interactive Controls
// Use the Synthesizer Controls panel to adjust:
// - Waveform type (Square, Sine, Triangle, Sawtooth)
// - Volume level
// - Note duration
// - Individual note frequencies

void setup() {
  pinMode(8, OUTPUT);
  Serial.begin(9600);
  Serial.println("=== Arduino Synthesizer ===");
  Serial.println("Use the control panel to customize your sounds!");
  Serial.println("Playing musical scale...");
}

void loop() {
  // Get note duration from control panel
  int duration = getNoteDuration();

  // Play ascending scale using frequencies from control panel
  for (int i = 0; i < 8; i++) {
    int freq = getNoteFrequency(i);
    Serial.print("Note ");
    Serial.print(i);
    Serial.print(": ");
    Serial.print(freq);
    Serial.println(" Hz");

    tone(8, freq);
    delay(duration);
    noTone(8);
    delay(100);
  }

  // Pause between repetitions
  Serial.println("--- Repeating ---");
  delay(1000);
}`,
            advSynth: `// Advanced Synthesizer with Filters and Envelopes
// Use the Controls panel to adjust:
// - Filter type (Lowpass, Highpass, Bandpass, Notch)
// - Filter frequency cutoff
// - Filter resonance (Q factor)
// - Oscillator detune (vibrato effect)
// - Attack and Release envelopes

void setup() {
  pinMode(8, OUTPUT);
  Serial.begin(9600);
  Serial.println("=== Advanced Synthesizer ===");
  Serial.println("Filter and modulation controls active!");

  // Enable filter
  setFilterEnabled(1);
  setFilterType("lowpass");
  setFilterFrequency(800);
  setFilterResonance(5);

  // Set envelope
  setAttack(0.05);
  setRelease(0.2);
}

void loop() {
  // Play chromatic scale with filter sweep
  int baseFreq = 220; // A3

  for (int i = 0; i < 13; i++) {
    // Calculate frequency (chromatic scale)
    float ratio = pow(2.0, i / 12.0);
    int freq = baseFreq * ratio;

    // Sweep filter frequency along with notes
    int filterFreq = 400 + (i * 100);
    setFilterFrequency(filterFreq);

    Serial.print("Note: ");
    Serial.print(freq);
    Serial.print(" Hz, Filter: ");
    Serial.print(filterFreq);
    Serial.println(" Hz");

    tone(8, freq);
    delay(200);
    noTone(8);
    delay(50);
  }

  Serial.println("--- Repeating ---");
  delay(1000);
}`
        };

        // Code Parser and Transpiler
        function transpileCode(code) {
            // Helper function to convert C++ types to JavaScript
            function convertCppTypes(code) {
                // Replace C++ type declarations with 'let'
                // This handles: int, float, long, bool, char, byte, unsigned int, unsigned long, etc.
                code = code.replace(/\b(unsigned\s+)?(int|float|long|bool|char|byte|short|double)\s+(?=\w)/g, 'let ');
                return code;
            }

            // Helper function to replace text outside of string literals
            function replaceOutsideStrings(code, search, replace) {
                const strings = [];
                let stringIndex = 0;

                // Temporarily replace string literals with placeholders
                code = code.replace(/(["'`])(?:(?=(\\?))\2.)*?\1/g, (match) => {
                    strings.push(match);
                    return `__STRING_${stringIndex++}__`;
                });

                // Perform the replacement
                if (typeof search === 'string') {
                    code = code.replace(new RegExp(search, 'g'), replace);
                } else {
                    code = code.replace(search, replace);
                }

                // Restore string literals
                code = code.replace(/__STRING_(\d+)__/g, (match, index) => {
                    return strings[parseInt(index)];
                });

                return code;
            }

            // Extract global variables
            let globalVars = '';
            const lines = code.split('\n');
            const codeLines = [];

            for (let line of lines) {
                const trimmed = line.trim();
                // Check if it's a global variable (before setup/loop)
                if (trimmed && !trimmed.startsWith('//') &&
                    !trimmed.includes('void setup()') &&
                    !trimmed.includes('void loop()')) {
                    // Check if line is before setup
                    const beforeSetup = code.indexOf(line) < code.indexOf('void setup()');
                    if (beforeSetup && (trimmed.includes('int ') || trimmed.includes('float ') ||
                        trimmed.includes('long ') || trimmed.includes('bool ') ||
                        trimmed.includes('char ') || trimmed.includes('byte ') ||
                        trimmed.includes('unsigned '))) {
                        globalVars += line + '\n';
                        continue;
                    }
                }
                codeLines.push(line);
            }

            code = codeLines.join('\n');

            // Convert C++ types in global variables
            globalVars = convertCppTypes(globalVars);

            // Replace Arduino constants (avoiding string literals)
            code = replaceOutsideStrings(code, /\bHIGH\b/g, 'arduino.HIGH');
            code = replaceOutsideStrings(code, /\bLOW\b/g, 'arduino.LOW');
            code = replaceOutsideStrings(code, /\bINPUT\b/g, 'arduino.INPUT');
            code = replaceOutsideStrings(code, /\bOUTPUT\b/g, 'arduino.OUTPUT');
            code = replaceOutsideStrings(code, /\bLED_BUILTIN\b/g, 'arduino.LED_BUILTIN');
            code = replaceOutsideStrings(code, /\bA0\b/g, 'arduino.A0');
            code = replaceOutsideStrings(code, /\bA1\b/g, 'arduino.A1');
            code = replaceOutsideStrings(code, /\bA2\b/g, 'arduino.A2');
            code = replaceOutsideStrings(code, /\bA3\b/g, 'arduino.A3');
            code = replaceOutsideStrings(code, /\bA4\b/g, 'arduino.A4');
            code = replaceOutsideStrings(code, /\bA5\b/g, 'arduino.A5');

            // Replace Math functions (avoiding string literals)
            code = replaceOutsideStrings(code, /\bpow\s*\(/g, 'Math.pow(');
            code = replaceOutsideStrings(code, /\bsqrt\s*\(/g, 'Math.sqrt(');
            code = replaceOutsideStrings(code, /\babs\s*\(/g, 'Math.abs(');
            code = replaceOutsideStrings(code, /\bsin\s*\(/g, 'Math.sin(');
            code = replaceOutsideStrings(code, /\bcos\s*\(/g, 'Math.cos(');
            code = replaceOutsideStrings(code, /\btan\s*\(/g, 'Math.tan(');

            // Replace Arduino functions (avoiding string literals)
            code = replaceOutsideStrings(code, /\bpinMode\s*\(/g, 'arduino.pinMode(');
            code = replaceOutsideStrings(code, /\bdigitalWrite\s*\(/g, 'arduino.digitalWrite(');
            code = replaceOutsideStrings(code, /\bdigitalRead\s*\(/g, 'arduino.digitalRead(');
            code = replaceOutsideStrings(code, /\banalogRead\s*\(/g, 'arduino.analogRead(');
            code = replaceOutsideStrings(code, /\banalogWrite\s*\(/g, 'arduino.analogWrite(');
            code = replaceOutsideStrings(code, /\bdelay\s*\(/g, 'await arduino.delay(');
            code = replaceOutsideStrings(code, /\bmillis\s*\(/g, 'arduino.millis(');
            code = replaceOutsideStrings(code, /\btone\s*\(/g, 'arduino.tone(');
            code = replaceOutsideStrings(code, /\bnoTone\s*\(/g, 'arduino.noTone(');
            code = replaceOutsideStrings(code, /\bgetNoteFrequency\s*\(/g, 'arduino.getNoteFrequency(');
            code = replaceOutsideStrings(code, /\bgetNoteDuration\s*\(/g, 'arduino.getNoteDuration(');
            code = replaceOutsideStrings(code, /\bsetFilterEnabled\s*\(/g, 'arduino.setFilterEnabled(');
            code = replaceOutsideStrings(code, /\bsetFilterType\s*\(/g, 'arduino.setFilterType(');
            code = replaceOutsideStrings(code, /\bsetFilterFrequency\s*\(/g, 'arduino.setFilterFrequency(');
            code = replaceOutsideStrings(code, /\bsetFilterResonance\s*\(/g, 'arduino.setFilterResonance(');
            code = replaceOutsideStrings(code, /\bsetDetune\s*\(/g, 'arduino.setDetune(');
            code = replaceOutsideStrings(code, /\bsetAttack\s*\(/g, 'arduino.setAttack(');
            code = replaceOutsideStrings(code, /\bsetRelease\s*\(/g, 'arduino.setRelease(');

            // Replace Serial functions (avoiding string literals)
            code = replaceOutsideStrings(code, /\bSerial\.begin\s*\(/g, 'arduino.Serial.begin(');
            code = replaceOutsideStrings(code, /\bSerial\.print\s*\(/g, 'arduino.Serial.print(');
            code = replaceOutsideStrings(code, /\bSerial\.println\s*\(/g, 'arduino.Serial.println(');

            // Extract setup and loop functions with proper brace matching
            function extractFunction(code, functionName) {
                const regex = new RegExp(`void\\s+${functionName}\\s*\\(\\s*\\)\\s*{`);
                const match = code.match(regex);
                if (!match) return null;

                const startIndex = match.index + match[0].length;
                let braceCount = 1;
                let i = startIndex;

                while (i < code.length && braceCount > 0) {
                    if (code[i] === '{') braceCount++;
                    else if (code[i] === '}') braceCount--;
                    i++;
                }

                if (braceCount !== 0) return null;
                return code.substring(startIndex, i - 1);
            }

            let setupBody = extractFunction(code, 'setup');
            let loopBody = extractFunction(code, 'loop');

            if (!setupBody || !loopBody) {
                throw new Error('Code must contain both setup() and loop() functions');
            }

            // Convert C++ types in setup and loop bodies
            setupBody = convertCppTypes(setupBody);
            loopBody = convertCppTypes(loopBody);

            return {
                globalVars,
                setup: `async function setup() {\n${setupBody}\n}`,
                loop: `async function loop() {\n${loopBody}\n}`
            };
        }

        // Execution Engine
        let isExecuting = false;
        let stopExecution = false;
        window.stopExecution = false;

        async function executeCode(code) {
            try {
                const transpiled = transpileCode(code);

                // Create function context with global variables
                const functionBody = `
                    ${transpiled.globalVars}
                    ${transpiled.setup}
                    ${transpiled.loop}

                    await setup();

                    while (!window.stopExecution) {
                        await loop();
                        if (window.stopExecution) break;
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                `;

                // Execute the code using AsyncFunction constructor
                const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                const asyncFunc = new AsyncFunction('arduino', functionBody);
                await asyncFunc(arduino);

            } catch (error) {
                throw error;
            }
        }

        // UI Updates
        function updateUI() {
            // Update LEDs
            document.querySelectorAll('.led').forEach((led, index) => {
                const pin = parseInt(led.getAttribute('data-pin'));
                const pwmValue = arduino.pwmPins[pin];

                if (pwmValue > 0) {
                    led.classList.add('on');
                    led.style.opacity = pwmValue / 255;
                } else {
                    led.classList.remove('on');
                    led.style.opacity = 1;
                }
            });

            // Update built-in LED
            const builtinLed = document.getElementById('builtinLed');
            const pin13Value = arduino.pwmPins[13];
            if (pin13Value > 0) {
                builtinLed.classList.add('on');
                builtinLed.style.opacity = pin13Value / 255;
            } else {
                builtinLed.classList.remove('on');
                builtinLed.style.opacity = 1;
            }

            // Update pin states
            updatePinStates();
        }

        function updatePinStates() {
            const grid = document.getElementById('pinStatesGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 14; i++) {
                const state = document.createElement('div');
                state.className = 'pin-state';

                const indicator = document.createElement('div');
                indicator.className = 'pin-state-indicator';
                if (arduino.pins[i] === 1) {
                    indicator.classList.add('high');
                }

                const name = document.createElement('span');
                name.className = 'pin-state-name';
                name.textContent = `D${i}:`;

                const value = document.createElement('span');
                value.className = 'pin-state-value';
                value.textContent = arduino.pins[i] === 1 ? 'HIGH' : 'LOW';

                state.appendChild(indicator);
                state.appendChild(name);
                state.appendChild(value);
                grid.appendChild(state);
            }
        }

        function setStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = 'status-indicator';
            if (status === 'running') {
                indicator.classList.add('running');
            } else if (status === 'error') {
                indicator.classList.add('error');
            }

            statusText.textContent = text;
        }

        // Event Handlers
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (isExecuting) return;

            const code = document.getElementById('codeEditor').value.trim();
            if (!code) {
                alert('Please enter some code first');
                return;
            }

            try {
                arduino.reset();
                arduino.addToSerial('=== Uploading sketch ===');
                setStatus('running', 'Running...');

                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;

                isExecuting = true;
                stopExecution = false;
                window.stopExecution = false;

                await executeCode(code);

            } catch (error) {
                setStatus('error', 'Error');
                arduino.addToSerial(`\n‚ùå Error: ${error.message}`);
                console.error(error);
            } finally {
                if (!stopExecution) {
                    setStatus('', 'Stopped');
                }
                isExecuting = false;
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            stopExecution = true;
            window.stopExecution = true;
            isExecuting = false;
            setStatus('', 'Stopped');
            arduino.addToSerial('\n=== Execution stopped ===');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            stopExecution = true;
            window.stopExecution = true;
            isExecuting = false;
            arduino.reset();
            setStatus('', 'Ready');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        });

        document.getElementById('clearSerialBtn').addEventListener('click', () => {
            document.getElementById('serialOutput').textContent = '';
        });

        document.getElementById('exampleSelect').addEventListener('change', (e) => {
            const example = e.target.value;
            if (example && examples[example]) {
                const editor = document.getElementById('codeEditor');
                if (editor.value.trim() && !confirm('Replace current code with example?')) {
                    e.target.value = '';
                    return;
                }
                editor.value = examples[example];
                e.target.value = '';
            }
        });

        // Speed control
        const speedValues = [0.25, 0.5, 1, 2, 4];
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            const speed = speedValues[e.target.value];
            arduino.setSpeedMultiplier(speed);
            document.getElementById('speedValue').textContent = speed + 'x';
        });

        // Analog input sliders
        document.querySelectorAll('input[data-analog]').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const pin = parseInt(e.target.getAttribute('data-analog'));
                const value = parseInt(e.target.value);
                arduino.analogPins[pin] = value;
                document.querySelector(`[data-value="${pin}"]`).textContent = value;
            });
        });

        // Synthesizer Controls
        document.getElementById('waveformSelect').addEventListener('change', (e) => {
            arduino.synthSettings.waveform = e.target.value;
        });

        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            const volume = parseInt(e.target.value) / 100;
            arduino.synthSettings.volume = volume;
            document.getElementById('volumeDisplay').textContent = e.target.value + '%';
        });

        document.getElementById('noteDurationSlider').addEventListener('input', (e) => {
            arduino.synthSettings.noteDuration = parseInt(e.target.value);
            document.getElementById('noteDurationDisplay').textContent = e.target.value + 'ms';
        });

        // Note frequency sliders
        for (let i = 0; i < 8; i++) {
            document.getElementById(`note${i}Slider`).addEventListener('input', (e) => {
                const freq = parseInt(e.target.value);
                arduino.synthSettings.noteFrequencies[i] = freq;
                document.getElementById(`note${i}Display`).textContent = freq;
            });
        }

        // Reset notes button
        document.getElementById('resetNotesBtn').addEventListener('click', () => {
            const defaultFreqs = [262, 294, 330, 349, 392, 440, 494, 523];
            for (let i = 0; i < 8; i++) {
                arduino.synthSettings.noteFrequencies[i] = defaultFreqs[i];
                document.getElementById(`note${i}Slider`).value = defaultFreqs[i];
                document.getElementById(`note${i}Display`).textContent = defaultFreqs[i];
            }
        });

        // Advanced Synthesizer Controls
        document.getElementById('advWaveformSelect').addEventListener('change', (e) => {
            arduino.synthSettings.waveform = e.target.value;
        });

        document.getElementById('advVolumeSlider').addEventListener('input', (e) => {
            const volume = parseInt(e.target.value) / 100;
            arduino.synthSettings.volume = volume;
            document.getElementById('advVolumeDisplay').textContent = e.target.value + '%';
        });

        document.getElementById('filterTypeSelect').addEventListener('change', (e) => {
            arduino.setFilterType(e.target.value);
        });

        document.getElementById('filterFreqSlider').addEventListener('input', (e) => {
            const freq = parseInt(e.target.value);
            arduino.setFilterFrequency(freq);
            document.getElementById('filterFreqDisplay').textContent = freq;
        });

        document.getElementById('filterQSlider').addEventListener('input', (e) => {
            const q = parseFloat(e.target.value);
            arduino.setFilterResonance(q);
            document.getElementById('filterQDisplay').textContent = q.toFixed(1);
        });

        document.getElementById('detuneSlider').addEventListener('input', (e) => {
            const detune = parseInt(e.target.value);
            arduino.setDetune(detune);
            document.getElementById('detuneDisplay').textContent = detune;
        });

        document.getElementById('attackSlider').addEventListener('input', (e) => {
            const attack = parseFloat(e.target.value);
            arduino.setAttack(attack);
            document.getElementById('attackDisplay').textContent = attack.toFixed(2);
        });

        document.getElementById('releaseSlider').addEventListener('input', (e) => {
            const release = parseFloat(e.target.value);
            arduino.setRelease(release);
            document.getElementById('releaseDisplay').textContent = release.toFixed(2);
        });

        // Reset advanced synth button
        document.getElementById('resetAdvSynthBtn').addEventListener('click', () => {
            arduino.advSynthSettings.filterType = 'lowpass';
            arduino.advSynthSettings.filterFrequency = 1000;
            arduino.advSynthSettings.filterResonance = 1;
            arduino.advSynthSettings.detune = 0;
            arduino.advSynthSettings.attack = 0.01;
            arduino.advSynthSettings.release = 0.1;

            document.getElementById('filterTypeSelect').value = 'lowpass';
            document.getElementById('filterFreqSlider').value = 1000;
            document.getElementById('filterFreqDisplay').textContent = '1000';
            document.getElementById('filterQSlider').value = 1;
            document.getElementById('filterQDisplay').textContent = '1.0';
            document.getElementById('detuneSlider').value = 0;
            document.getElementById('detuneDisplay').textContent = '0';
            document.getElementById('attackSlider').value = 0.01;
            document.getElementById('attackDisplay').textContent = '0.01';
            document.getElementById('releaseSlider').value = 0.1;
            document.getElementById('releaseDisplay').textContent = '0.10';
        });

        // Board panel tab switching
        document.querySelectorAll('.board-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Update active tab
                document.querySelectorAll('.board-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                document.querySelectorAll('.board-tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                if (tabName === 'board') {
                    document.getElementById('boardTabContent').classList.add('active');
                } else if (tabName === 'controls') {
                    document.getElementById('controlsTabContent').classList.add('active');
                }
            });
        });

        // Auto-switch to controls tab when synthesizer example is loaded
        document.getElementById('exampleSelect').addEventListener('change', (e) => {
            const example = e.target.value;
            const controlsTab = document.getElementById('controlsTab');
            const boardTab = document.querySelector('.board-tab[data-tab="board"]');
            const basicSynthControls = document.getElementById('basicSynthControls');
            const advSynthControls = document.getElementById('advSynthControls');

            // Show/hide appropriate controls based on example
            if (example === 'synthesizer') {
                // Show basic synth controls
                basicSynthControls.style.display = 'flex';
                advSynthControls.style.display = 'none';
                controlsTab.click();
            } else if (example === 'advSynth') {
                // Show advanced synth controls
                basicSynthControls.style.display = 'none';
                advSynthControls.style.display = 'flex';
                controlsTab.click();
            } else {
                // Hide all synth controls for other examples
                basicSynthControls.style.display = 'none';
                advSynthControls.style.display = 'none';
                boardTab.click();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('uploadBtn').click();
            } else if (e.key === 'Escape' && isExecuting) {
                e.preventDefault();
                document.getElementById('stopBtn').click();
            } else if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('clearSerialBtn').click();
            }
        });

        // Initialize
        updatePinStates();
        setStatus('', 'Ready');

        // Load default example
        document.getElementById('codeEditor').value = examples.blink;
    </script>
</body>
</html>
