<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAN Bus Analyzer - Code Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d30;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
            color: #569cd6;
        }

        .back-link {
            color: #569cd6;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #4ec9b0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 51px);
            padding: 20px;
            gap: 15px;
            overflow: hidden;
        }

        .input-section {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 14px;
            color: #4ec9b0;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        textarea {
            width: 100%;
            background: #2d2d30;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            line-height: 1.5;
            min-height: 120px;
        }

        textarea:focus {
            outline: none;
            border-color: #569cd6;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        button {
            background: #0e639c;
            color: #ffffff;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        button:hover {
            background: #1177bb;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #3c3c3c;
        }

        button.secondary:hover {
            background: #4a4a4a;
        }

        .output-section {
            flex: 1;
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            overflow-y: auto;
        }

        .message-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .message-card:hover {
            border-color: #569cd6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }

        .message-id {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #4ec9b0;
        }

        .message-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-standard {
            background: #0e639c;
            color: white;
        }

        .type-extended {
            background: #c586c0;
            color: white;
        }

        .message-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .detail-item {
            display: flex;
            gap: 8px;
        }

        .detail-label {
            color: #858585;
            font-size: 12px;
        }

        .detail-value {
            color: #569cd6;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: 600;
        }

        .data-section {
            margin-top: 10px;
        }

        .data-label {
            color: #858585;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .data-display {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .data-row {
            display: flex;
            gap: 15px;
            margin-bottom: 4px;
        }

        .data-hex {
            color: #ce9178;
        }

        .data-dec {
            color: #b5cea8;
        }

        .data-ascii {
            color: #9cdcfe;
        }

        .error-message {
            background: #3e1e1e;
            border: 1px solid #f48771;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            color: #f48771;
            font-size: 13px;
        }

        .info-section {
            background: #252526;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #3e3e42;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.6;
            flex-shrink: 0;
        }

        .info-section code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #ce9178;
        }

        .info-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .info-section li {
            margin-bottom: 4px;
        }

        .stats {
            background: #252526;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            font-size: 12px;
            color: #858585;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            gap: 5px;
        }

        .stat-value {
            color: #4ec9b0;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: #858585;
            padding: 40px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .message-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó CAN Bus Protocol Analyzer</h1>
        <a href="../" class="back-link">‚Üê Back to Tools</a>
    </div>

    <div class="container">
        <div class="info-section">
            <div class="section-title" style="margin-bottom: 8px;">Supported Formats</div>
            <p>Enter CAN bus messages in one of the following formats:</p>
            <ul>
                <li><code>123#1122334455667788</code> - Standard format: ID#DATA</li>
                <li><code>1FFFFFFF#1122334455667788</code> - Extended format: ID#DATA</li>
                <li><code>0x123#0x11 0x22 0x33</code> - With 0x prefix and spaces</li>
                <li><code>candump format: (1234.567) can0 123#1122334455</code></li>
            </ul>
            <p style="margin-top: 8px;">Each line represents one CAN message. Data bytes are in hexadecimal format.</p>
        </div>

        <div class="input-section">
            <div class="section-title">Input CAN Messages</div>
            <textarea id="input" placeholder="Enter CAN messages here, one per line...
Example:
123#0102030405060708
1FFFFFFF#DEADBEEF
0x456#0x11 0x22 0x33"></textarea>
            <div class="buttons">
                <button onclick="parseMessages()">üîç Parse Messages</button>
                <button class="secondary" onclick="loadExample()">üìù Load Example</button>
                <button class="secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <span>Total Messages:</span>
                <span class="stat-value" id="totalMessages">0</span>
            </div>
            <div class="stat-item">
                <span>Standard (11-bit):</span>
                <span class="stat-value" id="standardCount">0</span>
            </div>
            <div class="stat-item">
                <span>Extended (29-bit):</span>
                <span class="stat-value" id="extendedCount">0</span>
            </div>
            <div class="stat-item">
                <span>Total Bytes:</span>
                <span class="stat-value" id="totalBytes">0</span>
            </div>
        </div>

        <div class="output-section">
            <div class="section-title">Decoded Messages</div>
            <div id="output">
                <div class="empty-state">
                    No messages parsed yet. Enter CAN data above and click "Parse Messages".
                </div>
            </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const stats = document.getElementById('stats');

        function parseMessages() {
            const text = input.value.trim();

            if (!text) {
                output.innerHTML = '<div class="empty-state">No input provided. Please enter CAN messages.</div>';
                stats.style.display = 'none';
                return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            const messages = [];
            const errors = [];

            lines.forEach((line, index) => {
                try {
                    const message = parseCANMessage(line.trim());
                    if (message) {
                        messages.push(message);
                    }
                } catch (e) {
                    errors.push({ line: index + 1, message: e.message, raw: line });
                }
            });

            displayMessages(messages, errors);
            updateStats(messages);
        }

        function parseCANMessage(line) {
            // Remove candump timestamp and interface if present
            // Format: (timestamp) interface ID#DATA
            let cleaned = line.replace(/^\([^\)]+\)\s+\w+\s+/, '');

            // Split by # to separate ID and data
            const parts = cleaned.split('#');
            if (parts.length !== 2) {
                throw new Error('Invalid format. Expected ID#DATA');
            }

            // Parse ID
            let id = parts[0].trim().replace(/^0x/i, '');
            if (!/^[0-9A-Fa-f]+$/.test(id)) {
                throw new Error('Invalid ID format');
            }

            const idValue = parseInt(id, 16);
            const isExtended = id.length > 3 || idValue > 0x7FF;

            // Parse data bytes
            let dataStr = parts[1].trim();
            // Remove 0x prefixes and split by spaces or consecutive pairs
            dataStr = dataStr.replace(/0x/gi, '');

            let dataBytes = [];
            if (dataStr.includes(' ')) {
                // Space-separated bytes
                dataBytes = dataStr.split(/\s+/).filter(b => b.length > 0);
            } else {
                // Consecutive hex string
                dataBytes = dataStr.match(/.{1,2}/g) || [];
            }

            // Validate and convert data bytes
            const data = dataBytes.map(byte => {
                if (!/^[0-9A-Fa-f]{1,2}$/.test(byte)) {
                    throw new Error(`Invalid data byte: ${byte}`);
                }
                return parseInt(byte, 16);
            });

            if (data.length > 8) {
                throw new Error('CAN message data cannot exceed 8 bytes');
            }

            return {
                id: idValue,
                idHex: '0x' + idValue.toString(16).toUpperCase(),
                idBin: '0b' + idValue.toString(2).padStart(isExtended ? 29 : 11, '0'),
                isExtended: isExtended,
                dlc: data.length,
                data: data,
                raw: line
            };
        }

        function displayMessages(messages, errors) {
            let html = '';

            // Display errors first
            errors.forEach(error => {
                html += `
                    <div class="error-message">
                        <strong>Line ${error.line} Error:</strong> ${error.message}<br>
                        <code>${escapeHtml(error.raw)}</code>
                    </div>
                `;
            });

            // Display parsed messages
            messages.forEach((msg, index) => {
                const dataHex = msg.data.map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' ');
                const dataDec = msg.data.map(b => b.toString().padStart(3, ' ')).join(' ');
                const dataAscii = msg.data.map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : '.').join(' ');

                html += `
                    <div class="message-card">
                        <div class="message-header">
                            <div class="message-id">${msg.idHex}</div>
                            <div class="message-type ${msg.isExtended ? 'type-extended' : 'type-standard'}">
                                ${msg.isExtended ? 'Extended (29-bit)' : 'Standard (11-bit)'}
                            </div>
                        </div>

                        <div class="message-details">
                            <div class="detail-item">
                                <span class="detail-label">ID (Hex):</span>
                                <span class="detail-value">${msg.idHex}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ID (Dec):</span>
                                <span class="detail-value">${msg.id}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ID (Bin):</span>
                                <span class="detail-value">${msg.idBin}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">DLC:</span>
                                <span class="detail-value">${msg.dlc} byte${msg.dlc !== 1 ? 's' : ''}</span>
                            </div>
                        </div>

                        ${msg.data.length > 0 ? `
                            <div class="data-section">
                                <div class="data-label">Data Payload:</div>
                                <div class="data-display">
                                    <div class="data-row">
                                        <span style="color: #858585; min-width: 50px;">HEX:</span>
                                        <span class="data-hex">${dataHex}</span>
                                    </div>
                                    <div class="data-row">
                                        <span style="color: #858585; min-width: 50px;">DEC:</span>
                                        <span class="data-dec">${dataDec}</span>
                                    </div>
                                    <div class="data-row">
                                        <span style="color: #858585; min-width: 50px;">ASCII:</span>
                                        <span class="data-ascii">${dataAscii}</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (messages.length === 0 && errors.length === 0) {
                html = '<div class="empty-state">No valid messages found.</div>';
            }

            output.innerHTML = html;
        }

        function updateStats(messages) {
            if (messages.length === 0) {
                stats.style.display = 'none';
                return;
            }

            stats.style.display = 'flex';

            const standardCount = messages.filter(m => !m.isExtended).length;
            const extendedCount = messages.filter(m => m.isExtended).length;
            const totalBytes = messages.reduce((sum, m) => sum + m.dlc, 0);

            document.getElementById('totalMessages').textContent = messages.length;
            document.getElementById('standardCount').textContent = standardCount;
            document.getElementById('extendedCount').textContent = extendedCount;
            document.getElementById('totalBytes').textContent = totalBytes;
        }

        function loadExample() {
            input.value = `# Standard CAN messages (11-bit ID)
123#0102030405060708
456#DEADBEEF
0x1FF#1122334455
0x100#48656C6C6F

# Extended CAN messages (29-bit ID)
1FFFFFFF#0102030405060708
18FEF100#CAFEBABE
0x1234ABCD#FF00FF00

# candump format
(000000.123456) can0 123#1122334455667788
(000000.234567) vcan0 456#AABBCCDD`;
            parseMessages();
        }

        function clearAll() {
            input.value = '';
            output.innerHTML = '<div class="empty-state">No messages parsed yet. Enter CAN data above and click "Parse Messages".</div>';
            stats.style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Parse on Enter key
        input.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                parseMessages();
            }
        });
    </script>
</body>
</html>
